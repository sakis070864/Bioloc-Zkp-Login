import { NextResponse } from 'next/server'
import type { NextRequest } from 'next/server'

// Configuration
// We read the secret route from .env, or fallback to a default if missing (safety net)
const ADMIN_ROUTE_SECRET = process.env.ADMIN_ROUTE || 'Sakis@1964';

export function middleware(request: NextRequest) {
    const { pathname } = request.nextUrl;

    // 1. BLOCK DIRECT ACCESS TO /admin
    // If someone tries to visit /admin directly, we pretend it doesn't exist (404).
    if (pathname.startsWith('/admin')) {
        return NextResponse.rewrite(new URL('/404', request.url));
    }

    // 2. REWRITE SECRET ROUTE TO /admin
    // If someone visits /Sakis@1964, we show them the content of /admin
    // without changing the URL in the browser address bar.
    if (pathname.startsWith(`/${ADMIN_ROUTE_SECRET}`)) {
        // We need to preserve any sub-paths (e.g. /Sakis@1964/settings -> /admin/settings)
        const newPath = pathname.replace(`/${ADMIN_ROUTE_SECRET}`, '/admin');
        return NextResponse.rewrite(new URL(newPath, request.url));
    }

    // 3. ALLOW EVERYTHING ELSE
    return NextResponse.next();
}

// Configure which paths this middleware runs on
export const config = {
    matcher: [
        // Match the secret route and the actual admin route
        '/:path*',
    ],
}
